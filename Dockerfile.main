# PropertyPilot Enhanced AgentCore Service with Google Gemini
# Optimized for AWS Bedrock AgentCore with full observability, memory, identity, and tools
FROM --platform=linux/arm64 python:3.11-slim-bookworm

WORKDIR /app

# Install system dependencies including ADOT for observability
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    wget \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Skip AWS OTEL Collector installation for now (can be added later if needed)

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional AgentCore optimizations and Gemini support
RUN pip install --no-cache-dir \
    aws-opentelemetry-distro[otlp] \
    opentelemetry-instrumentation-fastapi \
    opentelemetry-instrumentation-boto3sqs \
    opentelemetry-instrumentation-requests \
    prometheus-client \
    'strands-agents[gemini]' \
    google-genai \
    bedrock-agentcore \
    nova-act

# Copy application code
COPY property_pilot_agents.py .
COPY bedrock_deployment.py .
COPY agentcore_deployment.py .
COPY automated_web_research.py .
COPY main.py .
COPY .env .

# Set environment variables for AgentCore optimization
ENV PYTHONPATH=/app
ENV AWS_DEFAULT_REGION=us-west-2
ENV MODEL_PROVIDER=gemini
ENV GEMINI_MODEL_ID=gemini-2.5-pro

# OpenTelemetry configuration for enhanced observability
ENV OTEL_SERVICE_NAME=propertypilot-main
ENV OTEL_SERVICE_VERSION=1.0.0
ENV OTEL_RESOURCE_ATTRIBUTES="service.name=propertypilot-main,service.version=1.0.0"
ENV OTEL_EXPORTER_OTLP_PROTOCOL=grpc
ENV OTEL_PYTHON_LOG_CORRELATION=true
ENV OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true

# AgentCore specific optimizations
ENV ENABLE_AGENTCORE_OBSERVABILITY=true
ENV SESSION_PERSISTENCE_ENABLED=true
ENV AUTO_SCALING_ENABLED=true
ENV MEMORY_OPTIMIZATION=true

# Performance optimizations
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV WORKERS=1
ENV MAX_REQUESTS=1000
ENV MAX_REQUESTS_JITTER=100

# Security enhancements
ENV PYTHONHASHSEED=random
ENV SECURE_HEADERS=true

# Expose port
EXPOSE 8080

# Enhanced health check with AgentCore integration
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8080/ping || exit 1

# Create non-root user for security
RUN useradd --create-home --shell /bin/bash app \
    && chown -R app:app /app
USER app

# Run with OpenTelemetry auto-instrumentation for full observability
CMD ["opentelemetry-instrument", "python", "main.py"]